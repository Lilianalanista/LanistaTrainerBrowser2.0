/*
 * File: app/controller/RegisterController.js
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.1.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.1.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('LanistaTrainer.controller.RegisterController', {
    extend: 'Ext.app.Controller',
    alias: 'controller.registerController',

    refs: {
        registerPanel: {
            autoCreate: true,
            selector: 'registerPanel',
            xtype: 'registerpanel'
        },
        mainStage: '#mainStage',
        rightCommandPanel: '#rightCommandPanel',
        mainViewport: 'mainViewport',
        leftCommandPanel: '#leftCommandPanel'
    },

    control: {
        "viewport #showRegisterPanelButton": {
            click: 'onShowRegisterPanelButtonClick'
        },
        "viewport #closeRegisterPanelButton": {
            click: 'onCloseRegisterPanelButtonClick'
        },
        "viewport #sendRegisterButton": {
            click: 'onSendRegisterButtonClick'
        }
    },

    onShowRegisterPanelButtonClick: function(button, e, eOpts) {
        LanistaTrainer.app.fireEvent('close' + LanistaTrainer.app.panels[LanistaTrainer.app.panels.length - 1], function() {
            LanistaTrainer.app.panels[LanistaTrainer.app.panels.length] = 'RegisterPanel';
            LanistaTrainer.app.fireEvent('showRegisterPanel');
        });


    },

    onCloseRegisterPanelButtonClick: function(button, e, eOpts) {
        LanistaTrainer.app.panels.splice(LanistaTrainer.app.panels.length - 1, 1);
        LanistaTrainer.app.fireEvent('closeRegisterPanel', function() {
            LanistaTrainer.app.fireEvent('show' + LanistaTrainer.app.panels[LanistaTrainer.app.panels.length - 1]);
        });


    },

    onSendRegisterButtonClick: function(button, e, eOpts) {
        var controller = this,
            form_data = controller.getRegisterPanel().getValues();

        if (!controller.verifyFields()) return;

        Ext.Ajax.request({
            url: Ext.ux.ConfigManager.getRoot() +'/tpmanager/user/registercustomer',
            method: 'post',
            params: {email: form_data.emailAdresse1,
                     email_confirmation: form_data.emailAdresse2,
                     password: form_data.passwordReg,
                     role: 2,
                     language: form_data.customer_languageReg
                    },
            failure : function(result, request){
                console.log( "There were problems in looking for user information" );
            },
            success: function(response, opts) {
                try {
                    data = Ext.decode(response.responseText);
                    if (!data.success){
                        if (data.error === -1){
                            Ext.Msg.alert(Ext.ux.LanguageManager.TranslationArray.MSG_REGISTRAION_PROB_1,
                                      Ext.ux.LanguageManager.TranslationArray.MSG_REGISTRATION_ERROR, Ext.emptyFn);
                        }
                        else{
                            Ext.Msg.alert(Ext.ux.LanguageManager.TranslationArray.MSG_REGISTRAION_PROB_1,
                                      Ext.ux.LanguageManager.TranslationArray.MSG_REGISTRAION_PROB_2, Ext.emptyFn);                }
                    }
                    else{
                        Ext.Msg.alert(Ext.ux.LanguageManager.TranslationArray.MSG_REGISTRATION_OK_1,
                                      Ext.ux.LanguageManager.TranslationArray.MSG_REGISTRATION_OK_2, Ext.emptyFn);
                        LanistaTrainer.app.panels.splice(LanistaTrainer.app.panels.length - 1, 1);
                        LanistaTrainer.app.fireEvent('closeRegisterPanel', function() {
                            LanistaTrainer.app.fireEvent('show' + LanistaTrainer.app.panels[LanistaTrainer.app.panels.length - 1]);
                        });
                    }
                }
                catch( err ) {
                    Ext.Msg.alert(Ext.ux.LanguageManager.TranslationArray.MSG_REGISTRAION_PROB_1,
                                  Ext.ux.LanguageManager.TranslationArray.MSG_REGISTRATION_ERROR, Ext.emptyFn);
                }
            }
        });
    },

    onShowRegisterPanel: function(callback) {
        var controller = this,
            registrationPanel	= controller.getRegisterPanel(),
            mainStage	= controller.getMainStage();

        controller.getMainViewport().addCls("lanista-registration");

        mainStage.add( registrationPanel );

        registrationPanel.on('hide', function(component) {
            component.destroy();
        }, controller);


        // **** 1 create the commands
        LanistaTrainer.app.setStandardButtons('closeRegisterPanelButton');
        this.showCommands();

        // *** 2 Show the panel
        registrationPanel.show();

        controller.getMainViewport().down("#header").el.dom.children[0].innerHTML = 'Lanista';

        LanistaTrainer.app.fireEvent('showStage');

        // *** 4 Callback
        if (callback instanceof Function) callback();

        // *** 5 Load data
        controller.loadData();




    },

    onCloseRegisterPanel: function(callback) {
        var controller = this;
        LanistaTrainer.app.fireEvent('hideStage', function () {
            controller.getRightCommandPanel().items.each(function (item) {
                item.hide();
            });
            controller.getLeftCommandPanel().items.each(function (item) {
                item.hide();
            });
            controller.getRegisterPanel().hide();
            if (callback instanceof Function) callback();
        });
    },

    showCommands: function(callback) {
        var controller = this;

        controller.getRightCommandPanel().items.each(function (item) {
            item.hide();
        });

        this.getRightCommandPanel().add(
            Ext.create('LanistaTrainer.view.LanistaButton', {
                text: Ext.ux.LanguageManager.TranslationArray.FORM_SEND,
                itemId: 'sendRegisterButton',
                glyph: '100@Lanista Icons' //d
            })
        );

        /*
        this.getRightCommandPanel().add(
            Ext.create('LanistaTrainer.view.LanistaButton', {
                text: Ext.ux.LanguageManager.TranslationArray.MENU_LOGIN,
                itemId: 'loginButton',
                userAlias: 'loginButton',
                glyph: '101@Lanista Icons' //e
            })
        );
        */

    },

    loadData: function() {

    },

    verifyFields: function() {
        var controller = this,
            form = controller.getRegisterPanel(),
            form_data = form.getValues(),
            email = form_data.emailAdresse1,
            email2 = form_data.emailAdresse2,
            password = form_data.passwordReg,
            password2 = form_data.passwordReg1,
            language = form_data.customer_languageReg,
            agb = form.items.items[0].items.items[1].items.items[5].value,
            reg;

            if (email === '' || password === ''){
                Ext.Msg.alert(Ext.ux.LanguageManager.TranslationArray.MSG_EMPTY_TEXT, Ext.ux.LanguageManager.TranslationArray.MSG_TRY_AGAIN, function() {
                    if (email === '')
                        document.getElementsByName("emailAdresse1")[0].focus();
                    else
                        document.getElementsByName("passwordReg")[0].focus();

                });
              return false;
            }

            if (email2 === ''){
                Ext.Msg.alert(Ext.ux.LanguageManager.TranslationArray.MSG_SYNC_ERROR_2.trim().substr(0,1).toUpperCase() +
                              Ext.ux.LanguageManager.TranslationArray.MSG_SYNC_ERROR_2.trim().substr(1),
                                      Ext.ux.LanguageManager.TranslationArray.USER_EMAIL_REP, function() {
                                          document.getElementsByName("emailAdresse2")[0].focus();
                                      });
                return false;
            }

            if (password2 === ''){
                Ext.Msg.alert(Ext.ux.LanguageManager.TranslationArray.MSG_SYNC_ERROR_2.trim().substr(0,1).toUpperCase() +
                              Ext.ux.LanguageManager.TranslationArray.MSG_SYNC_ERROR_2.trim().substr(1),
                                      Ext.ux.LanguageManager.TranslationArray.MSG_PASSWORD_CONFIRMATION_ERROR_2, function() {
                                          document.getElementsByName("passwordReg1")[0].focus();
                                      });
                return false;
            }

            if (!agb){
                Ext.Msg.alert(Ext.ux.LanguageManager.TranslationArray.MSG_AGREE_LA_1,
                              Ext.ux.LanguageManager.TranslationArray.MSG_AGREE_LA_2);
                return false;
            }

            reg = /^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/;
            if (reg.test(email) === false) {
                Ext.Msg.alert(Ext.ux.LanguageManager.TranslationArray.MSG_EMAIL_INVALID_1, Ext.ux.LanguageManager.TranslationArray.MSG_TRY_AGAIN,function(){
                    document.getElementsByName("emailAdresse1")[0].focus();
                });
                return false;
            }

            if (reg.test(email2) === false) {
                Ext.Msg.alert(Ext.ux.LanguageManager.TranslationArray.MSG_EMAIL_INVALID_1, Ext.ux.LanguageManager.TranslationArray.MSG_TRY_AGAIN, function() {
                    document.getElementsByName("emailAdresse2")[0].focus();
                });
                return false;
            }

            if (password.lenght < 6){
                Ext.Msg.alert(Ext.ux.LanguageManager.TranslationArray.MSG_PASSWORD_CONFIRMATION_ERROR_1,
                              Ext.ux.LanguageManager.TranslationArray.MSG_PASSWORD_CONFIRMATION_ERROR_2, function() {
                                  document.getElementsByName("passwordReg")[0].focus();
                              });
                return false;
            }

            if (email !== email2){
                //Ext.Msg.alert(Ext.ux.LanguageManager.TranslationArray.MSG_PASSWORD_CONFIRMATION_ERROR_1,
                //              Ext.ux.LanguageManager.TranslationArray.MSG_PASSWORD_CONFIRMATION_ERROR_2);
                Ext.Msg.alert('La dirección de correo de confirmación no coincide con la dirección de correo indicada',
                              Ext.ux.LanguageManager.TranslationArray.MSG_TRY_AGAIN, function() {
                                  document.getElementsByName("emailAdresse1")[0].focus();
                              });
                return false;
            }

            if (password !== password2){
                //Ext.Msg.alert(Ext.ux.LanguageManager.TranslationArray.MSG_PASSWORD_CONFIRMATION_ERROR_1,
                //              Ext.ux.LanguageManager.TranslationArray.MSG_PASSWORD_CONFIRMATION_ERROR_2);
                Ext.Msg.alert('El password de confirmación no coincide con el password indicado',
                              Ext.ux.LanguageManager.TranslationArray.MSG_TRY_AGAIN, function() {
                                  document.getElementsByName("passwordReg")[0].focus();
                              });
                return false;
            }

            return true;
    },

    init: function(application) {
        application.on({
            ShowRegisterPanel: {
                fn: this.onShowRegisterPanel,
                scope: this
            },
            closeRegisterPanel: {
                fn: this.onCloseRegisterPanel,
                scope: this
            }
        });
    }

});
